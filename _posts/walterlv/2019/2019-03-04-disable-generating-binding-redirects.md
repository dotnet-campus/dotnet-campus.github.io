---
title: ".NET 应用启用与禁用自动生成绑定重定向 (bindingRedirect)，解决不同版本 dll 的依赖问题"
publishDate: 2019-03-04 21:37:58 +0800
date: 2019-04-12 09:40:20 +0800
categories: dotnet visualstudio msbuild
position: knowledge
---

当你的项目中多个不同的项目以及不同的依赖存在不同的依赖程序集时，可能会因为依赖于不同版本的程序集而产生冲突。而绑定重定向可以帮助解决不同程序集的依赖版本不同的问题，使整个程序使用统一个版本的 dll 来运行整个应用程序。

然而，如果我们就是需要使用一个分离的不同版本，那么我们就需要禁用掉自动生成绑定重定向。本文介绍如何禁用自动生成绑定重定向。

---

本文的结论只有一句，就是在项目中设置属性 `<AutoGenerateBindingRedirects>false</AutoGenerateBindingRedirects>`。阅读本文全文是了解更多与绑定重定向此场景相关的知识。

<div id="toc"></div>

## 绑定重定向

从 .NET Framework 4.5.1 开始到后面的 .NET Core 所有版本，编译器会自动向你的程序集中插入绑定重定向。如果你升级使用了新的 csproj 格式，即便你用了旧的 .NET Framework 也会自动生成绑定重定向。

关于新旧 csproj 格式，你可以参考我的另一篇博客：[将 WPF、UWP 以及其他各种类型的旧 csproj 迁移成 Sdk 风格的 csproj - walterlv](/post/introduce-new-style-csproj-into-net-framework)。

你可以在你的应用程序的 App.config 文件中查看到自动生成的绑定重定向。当然，编译之后这个 App.config 文件会编程 “你的程序集名称.config” 文件，例如对于我的 `Walterlv.Demo.exe` 程序对应 `Walterlv.Demo.exe.config` 文件。

一个典型的包含绑定重定向的文件大概是下面这样的：

```xml
<?xml version="1.0" encoding="utf-8"?>
<configuration>
    <startup useLegacyV2RuntimeActivationPolicy="true">
        <supportedRuntime version="v4.0" sku=".NETFramework,Version=v4.6" />
    </startup>
    <runtime>
        <assemblyBinding xmlns="urn:schemas-microsoft-com:asm.v1">
            <dependentAssembly>
                <assemblyIdentity name="Newtonsoft.Json" publicKeyToken="30ad4fe6b2a6aeed" culture="neutral" />
                <bindingRedirect oldVersion="0.0.0.0-11.0.0.0" newVersion="11.0.0.0" />
            </dependentAssembly>
            <dependentAssembly>
                <assemblyIdentity name="System.ValueTuple" publicKeyToken="cc7b13ffcd2ddd51" culture="neutral" />
                <bindingRedirect oldVersion="0.0.0.0-4.0.3.0" newVersion="4.0.3.0" />
            </dependentAssembly>
        </assemblyBinding>
    </runtime>
</configuration>
```

上面 `dependentAssembly` 以及 `bindingRedirect` 就是在描述绑定重定向。

对于上面的代码，指的是：

1. 如果依赖中发现了任何 `0.0.0.0-11.0.0.0` 区间版本号的 Newtonsoft.Json 程序集的引用，都将使用 11.0.0.0 版本的。
1. 如果以来中发现了任何 `0.0.0.0-4.0.3.0` 区间版本号的 System.ValueTuple 程序集的引用，都将使用 4.0.3.0 版本的（这个其实使用的 NuGet 包版本是 4.5）。

## 引用同名但不同版本的 dll

绑定重定向多数时候都是在帮助我们解决依赖问题，然而我们总有一些时候不是按照常规的方式来使用依赖，例如下文这样的方式：

- [引用不用版本dll - dang13579的专栏 - CSDN博客](https://blog.csdn.net/dang13579/article/details/72956684)
- [C# 引用不同版本dll - 晒太阳的猫](https://jgrass.cc/2017-11-C-%E4%B8%AD%E5%BC%95%E7%94%A8%E4%B8%8D%E5%90%8C%E7%89%88%E6%9C%ACDLL/)
- [同一个解决方案或有依赖关系的两个项目引用同名但不同版本的DLL - gudi - 博客园](http://www.cnblogs.com/gudi/p/6958297.html)

以上文章的场景，是需要在同一个解决方案的不同项目中引用不同版本的同名 dll。解决方法是像下面这样：

```xml
<dependentAssembly>
    <assemblyIdentity name="LiteDB" publicKeyToken="4ee40123013c9f27" culture="neutral" />
    <codeBase version="2.0.2.0" href="LiteDB.2.0.2.0\LiteDB.dll" />
    <codeBase version="4.0.0.0" href="LiteDB.4.0.0.0\LiteDB.dll" />
</dependentAssembly>
```

于是，如果引用了 2.0.2.0 版本的 LiteDB 的时候，会去应用程序所在目录的 LiteDB.2.0.2.0 子目录中查找名为 LiteDB.dll 的引用 dll；而如果引用了 4.0.0.0 版本的 LiteDB 的时候，会去应用程序所在目录的 LiteDB.4.0.0.0 子目录中查找名为 LiteDB.dll 的引用 dll。这种方式使用两个 dll 互不干扰。

## 禁用绑定重定向

如果你的项目从 .NET Framework 4.5 或者更早版本升级到 .NET Framework 4.5.1 或者 .NET Core 的版本，或者 csproj 的格式升级到了新的基于 Microsoft.NET.Sdk 的版本，那么绑定重定向就会从之前的手动编程自动生成。

但是如果你编写了上一节中我们讲到的你需要引用同名程序集的多个版本的时候，如果依然自动生成绑定重定向，那么上面的功能会失效。

解决方法，便是禁用自动生成绑定重定向。在你的主项目中添加一个属性：

```xml
<AutoGenerateBindingRedirects>false</AutoGenerateBindingRedirects>
```

---

**参考资料**

- [Enable or disable autogenerated binding redirects - Microsoft Docs](https://docs.microsoft.com/en-us/dotnet/framework/configure-apps/how-to-enable-and-disable-automatic-binding-redirection)
